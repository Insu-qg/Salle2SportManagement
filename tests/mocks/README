# ğŸ§ª Ã‰tape 2 â€“ StratÃ©gie de Mocking

## ğŸ¯ Objectif

DÃ©finir une stratÃ©gie claire de mocking afin de :

* Garantir lâ€™isolation des **tests unitaires (TU)**.
* ContrÃ´ler les dÃ©pendances dans les **tests dâ€™intÃ©gration (TI)**.
* Assurer **la reproductibilitÃ© et la rapiditÃ©** des tests.
* RÃ©duire les risques de fausses erreurs causÃ©es par lâ€™environnement externe (DB, API, etc.).

---

## 1. ğŸ“¦ DÃ©pendances Ã  mocker

| Type                      | Ã‰lÃ©ment                                   | Pourquoi le mocker ?                                  | Niveau  |
| ------------------------- | ----------------------------------------- | ----------------------------------------------------- | ------- |
| **Base de donnÃ©es**       | Prisma Client (`prisma.user.findMany`)    | Ne pas dÃ©pendre dâ€™un vrai SGBD dans les TU            | TU / TI |
| **Services tiers**        | `BillingService`, `EmailService`          | Eviter les effets de bord (ex. : facturation, envois) | TU / TI |
| **Middleware auth**       | `isAuthenticated`, `hasRole(ADMIN)`       | ContrÃ´ler les cas utilisateurs sans login rÃ©el        | TU / TI |
| **RequÃªtes rÃ©seau**       | Appels REST entre front/back              | Eviter les dÃ©pendances inter-app                      | TU      |
| **Date/time**             | `Date.now()`, `new Date()`                | ContrÃ´ler les effets temporels (pÃ©nalitÃ©s, dÃ©lais)    | TU      |
| **Fonctions utilitaires** | `calculatePenalty()`, `conflictChecker()` | Tester indÃ©pendamment des cas business                | TU      |

---

## 2. ğŸ§° Outils & MÃ©thodes utilisÃ©s

| MÃ©thode  | Utilisation typique                                | Outils         |
| -------- | -------------------------------------------------- | -------------- |
| **Mock** | Simulation simple avec suivi dâ€™appels              | Vitest / Jest  |
| **Stub** | Comportement fixe pour tester diffÃ©rents scÃ©narios | Sinon / Vitest |
| **Fake** | ImplÃ©mentation simplifiÃ©e (ex. fake DB, factory)   | Factory.ts     |

---

## 3. âœ… Exemples de structure de mocks (tests/mocks/)

### ğŸ“ `tests/mocks/`

```
tests/
â”œâ”€â”€ mocks/
â”‚   â”œâ”€â”€ prisma.mock.ts              # Mock du client Prisma
â”‚   â”œâ”€â”€ billingService.mock.ts      # Mock du service de facturation
â”‚   â”œâ”€â”€ auth.middleware.mock.ts     # Mock de lâ€™authentification
â”‚   â”œâ”€â”€ date.mock.ts                # Mock de Date.now() pour pÃ©nalitÃ©s
â”‚   â”œâ”€â”€ factories/
â”‚   â”‚   â”œâ”€â”€ userFactory.ts          # CrÃ©ation dâ€™utilisateurs mock
â”‚   â”‚   â”œâ”€â”€ classFactory.ts         # CrÃ©ation de cours simulÃ©s
â”‚   â”‚   â””â”€â”€ subscriptionFactory.ts  # CrÃ©ation dâ€™abonnements
```

---

## 4. ğŸ§ª Cas dâ€™usage typiques

| Test ciblÃ©                     | Ce quâ€™on mock  | Exemple de scÃ©nario                      |
| ------------------------------ | -------------- | ---------------------------------------- |
| `BookingService.reserve()`     | Prisma + Date  | Tester un double booking ou une pÃ©nalitÃ© |
| `SubscriptionController.put()` | BillingService | Simuler une erreur de paiement           |
| `GET /dashboard/user/:id`      | Prisma         | VÃ©rifier le rendu sans vraie base        |
| Authentification front-end     | Middleware     | Simuler diffÃ©rents rÃ´les (USER / ADMIN)  |

---

## 5. ğŸ”§ Factories & helpers

Nous avons ajoutÃ© dans `tests/mocks/factories/` des **factories rÃ©utilisables** pour :

* GÃ©nÃ©rer des utilisateurs, cours, abonnements valides ou cassÃ©s.
* Simuler des cas aux limites (capacitÃ© atteinte, no-showâ€¦).

Exemple :

```ts
// userFactory.ts
export function createUser(overrides = {}) {
  return {
    id: 'user-123',
    email: 'test@gym.com',
    role: 'USER',
    ...overrides,
  };
}
```

---